
<style>
	.swig {
		background-color: rgb(20,20,20);
	}

	.galaxy-box {
		stroke: darkgray;
		stroke-width: 2px;
		fill: black;
	}

	.grid-line {
		stroke: darkgray;
	}

	.grid-level-1 {
		stroke-width: 0.75px;
	}

	.grid-level-2 {
		stroke-width: 0.5px;
	}

	.grid-level-3 {
		stroke-width: 0.25px;
	}

	.planet {
		fill: lightblue;
		r: 1.5px;
	}
</style>

@if (Galaxy != null)
{
	<SvgBox CssClass="swig" 
			OnClick="TargetObject" 
			OnWheel="Zoom" 
			Width="@Width" 
			Height="@Height" 
			Zoom="@ScaleRate"
			FocusOn="@focus">

		<rect x="@(-gridSide)" y="@(-gridSide)" width="@Galaxy.Size" height="@Galaxy.Size" class="galaxy-box" />

		@foreach (var (coord, level) in GetGridLines())
		{
			<line x1="@(-gridSide)" x2="@gridSide" y1="@coord" y2="@coord" class="@($"grid-line grid-level-{level}")" />
			<line y1="@(-gridSide)" y2="@gridSide" x1="@coord" x2="@coord" class="@($"grid-line grid-level-{level}")" />
		}

		@foreach (var p in Galaxy.Planets)
		{
			<circle cx="@p.Position.X" cy="@p.Position.Y" class="planet" />
		}

		@ChildContent

	</SvgBox>
}

@code
{
	private IEnumerable<(int, int)> GetGridLines()
	{
		yield return (-gridSide * 3 / 4, 3);
		yield return (-gridSide / 4, 3);
		yield return (-gridSide / 2, 2);
		yield return (0, 1);
		yield return (gridSide / 2, 2);
		yield return (gridSide / 4, 3);
		yield return (gridSide * 3 / 4, 3);
	}

	int gridMid => 0;
	int gridSide => Galaxy.Size / 2;

	SvgBox.Focus focus = new SvgBox.Focus() { View = Vector.Zero };

	[Parameter]
	public int Width { get; set; }

	[Parameter]
	public int Height { get; set; }

	[Parameter]
	public double ScaleRate { get; set; } = 1;

	[Parameter]
	public Galaxy Galaxy { get; set; }

	[Parameter]
	public RenderFragment ChildContent { get; set; }

	[Parameter]
	public EventCallback<Planet> OnPlanetSelected { get; set; }

	[Parameter]
	public EventCallback<double> ScaleRateChanged { get; set; }

	private async Task TargetObject(SvgBox.SvgMouseEventArgs e)
	{
		var pos = new Position((int)e.SvgCoords.X, (int)e.SvgCoords.Y);
		var target = Galaxy.ClosestPlanet(pos);
		await OnPlanetSelected.InvokeAsync(target);
	}

	private async Task Zoom(SvgBox.SvgWheelEventArgs e)
	{
		ScaleRate *= (e.WheelDelta < 0 ? 1.25: 0.8);
		focus.Screen = e.ScreenCoords;
		focus.View = e.SvgCoords;

		await ScaleRateChanged.InvokeAsync(ScaleRate);
	}
}
