
<style>
	.swig {
		background-color: rgb(20,20,20);
	}

	.galaxy-box {
		stroke: rgb(20,40,60);
		stroke-width: 2px;
		fill: black;
	}

	.grid-line {
		stroke: rgb(20,40,60);
	}

	.grid-level-1 {
		stroke-width: 0.75px;
	}

	.grid-level-2 {
		stroke-width: 0.5px;
	}

	.grid-level-3 {
		stroke-width: 0.25px;
	}

	.planet {
		fill: rgb(40,60,60);
	}

	.colony {
		fill: rgb(120,220,140);
	}
</style>

@if (Galaxy != null)
{
	<SvgBox CssClass="swig" 
			OnClick="TargetObject" 
			FocusOn="@focus">

		<rect x="@Galaxy.Bounds.Min" y="@Galaxy.Bounds.Min" width="@Galaxy.Bounds.Size" height="@Galaxy.Bounds.Size" class="galaxy-box" />

		@foreach (var (coord, level) in GetGridLines())
		{
			<line x1="@Galaxy.Bounds.Min" x2="@Galaxy.Bounds.Max" y1="@coord" y2="@coord" class="@($"grid-line grid-level-{level}")" />
			<line y1="@Galaxy.Bounds.Min" y2="@Galaxy.Bounds.Max" x1="@coord" x2="@coord" class="@($"grid-line grid-level-{level}")" />
		}

		@foreach (var p in Galaxy.Planets)
		{
			<circle cx="@p.Position.X" cy="@p.Position.Y" r="1.5" class="@(p.OwnerId.HasValue ? "colony" : "planet")" />
		}

		@ChildContent

	</SvgBox>
}

@code
{
	private IEnumerable<(int, int)> GetGridLines()
	{
		var bounds = Galaxy.Bounds;
		var L2Min = Mid(bounds.Mid, bounds.Min);
		var L2Max = Mid(bounds.Mid, bounds.Max);

		// L3
		yield return (Mid(bounds.Min, L2Min), 3);
		yield return (Mid(bounds.Mid, L2Min), 3);
		yield return (Mid(bounds.Mid, L2Max), 3);
		yield return (Mid(bounds.Max, L2Max), 3);

		// L2
		yield return (L2Min, 2);
		yield return (L2Max, 2);

		// L1
		yield return (bounds.Mid, 1);

		int Mid(int a, int b) => (a + b) / 2;
	}

	SvgBox.Focus focus = new SvgBox.Focus() { View = Vector.Zero };

	[Parameter]
	public IGalaxy Galaxy { get; set; }

	[Parameter]
	public RenderFragment ChildContent { get; set; }

	[Parameter]
	public EventCallback<Planet> OnPlanetSelected { get; set; }

	private async Task TargetObject(SvgBox.SvgMouseEventArgs e)
	{
		var pos = new Position((int)e.SvgCoords.X, (int)e.SvgCoords.Y);
		var target = Galaxy.ClosestPlanet(pos);
		await OnPlanetSelected.InvokeAsync(target);
	}
}
