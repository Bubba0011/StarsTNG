@inject IJSRuntime JSRuntime

@if (Galaxy != null)
{
	<svg viewBox="@(Box.X) @(Box.Y) @(Box.Width) @(Box.Height)"
		 width="@Galaxy.Size" height="@Galaxy.Size"
		 style="background-color: black"
		 @ref="SVG"
		 @onclick="TargetObject"
		 @onwheel="Zoom">

		<line x1="@Box.X" x2="@Box.Width" y1="@(Box.MidY)" y2="@(Box.MidY)" stroke="grey" stroke-width="0.1%" />
		<line y1="@Box.Y" y2="@Box.Height" x1="@(Box.MidX)" x2="@(Box.MidX)" stroke="grey" stroke-width="0.1%" />

		@foreach (var p in Galaxy.Planets)
		{
			<circle cx="@p.Position.X" cy="@p.Position.Y" r="0.1%" fill="white" />
		}

		@ChildContent
	</svg>
}

@code
{
	ElementReference SVG;

	private ViewBox Box { get; set; }
	private Position zoomPosition;
	private double ScaleRate { get; set; }

	private Galaxy _galaxy;
	[Parameter]
	public Galaxy Galaxy
	{
		get => _galaxy;
		set
		{
			_galaxy = value;
			ResetViewBox();
		
		}
	}

	[Parameter]
	public RenderFragment ChildContent { get; set; }

	[Parameter]
	public EventCallback<Planet> OnPlanetSelected { get; set; }

	protected override void OnInitialized()
	{
		ScaleRate = 1;
		ResetViewBox();
	}

	private async Task TargetObject(MouseEventArgs e)
	{
		Position clickCoords = await JSRuntime.InvokeAsync<Position>("retrieveElementPosition", SVG, e);
		var target = Galaxy.ClosestPlanet(clickCoords);
		await OnPlanetSelected.InvokeAsync(target);
	}

	private async Task Zoom(WheelEventArgs e)
	{
		zoomPosition = await JSRuntime.InvokeAsync<Position>("retrievePosFromCorner", SVG, e);
		int wheel = e.DeltaY < 0 ? 1 : -1;
		UpdateViewBox(zoomPosition.X, zoomPosition.Y, wheel);
	}

	private void UpdateViewBox(int zoomX, int zoomY, int wheel)
	{
		var zoomIntensity = 0.2;
		var zoom = Math.Exp(wheel * zoomIntensity);
		// Calculate new corner node so the mouse position is the same before and after the zoom
		int x = Box.X - (int)(zoomX / (ScaleRate * zoom) - zoomX / ScaleRate);
		int y = Box.Y - (int)(zoomY / (ScaleRate * zoom) - zoomY / ScaleRate);
		ScaleRate *= zoom;
		int height = (int)(Galaxy.Size / ScaleRate);

		Box = new ViewBox()
		{
			X = x,
			Y = y,
			Height = height,
			Width = height
		};

	}

	private void ResetViewBox()
	{
		Box = new ViewBox()
		{
			X = -(Galaxy.Size / 2),
			Y = -(Galaxy.Size / 2),
			Height = Galaxy.Size,
			Width = Galaxy.Size
		};
	}

	public struct ViewBox
	{
		public int X { get; set; }
		public int Y { get; set; }
		public int Width { get; set; }
		public int Height { get; set; }
		public int MidX => X + Width / 2;
		public int MidY => Y + Height / 2;
	}
}
